<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>PayCal: By Taranveer</title>
		<link rel="icon" type="image/x-icon" href="/Logos/black icon.svg" />
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
			rel="stylesheet"
			integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
			crossorigin="anonymous"
		/>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/devicons/devicon@v2.15.1/devicon.min.css" />
		<link rel="stylesheet" href="/css/prism.css" />
		<link rel="stylesheet" href="/css/site.css" />
	</head>
	<body>
		<!-- bscf-navbar-base -->
		<nav class="navbar navbar-expand-lg navbar-dark">
			<div class="container-fluid">
				<a class="navbar-brand" href="/index.html">
					<img src="/Logos/white icon.svg" height="40" />
					PayCal
				</a>
				<button
					class="navbar-toggler"
					type="button"
					data-bs-toggle="collapse"
					data-bs-target="#navbarSupportedContent"
					aria-controls="navbarSupportedContent"
					aria-expanded="false"
					aria-label="Toggle navigation"
				>
					<span class="navbar-toggler-icon"></span>
				</button>
				<div class="collapse navbar-collapse" id="navbarSupportedContent">
					<ul class="navbar-nav me-auto mb-2 mb-lg-0">
						<li class="nav-item">
							<a class="nav-link" href="/index.html">Home</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="/app.html">The App</a>
						</li>
						<li class="nav-item">
							<a class="nav-link active" aria-current="page" href="/code.html">The Code</a>
						</li>
						<li class="nav-item">
							<!-- change to real repo link -->
							<a class="nav-link" target="_blank" href="https://github.com/taranveersingh93/paycal">The Repo</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" target="_blank" href="https://stirring-medovik-226616.netlify.app/">About</a>
						</li>
						<li class="nav-item">
							<!-- Write a blog post about the challenge -->
							<a class="nav-link" target="_blank" href="#">Blog</a>
						</li>
					</ul>
				</div>
			</div>
		</nav>

		<main class="container py-3">
			<h1 class="border-bottom border-2 border-dark">The Code</h1>
			<div class="row">
				<div class="col-12 col-lg-8">
					<!-- pre formatted text. indents and spacing will be preserved -->
					<pre class="line-numbers">
						<code class="language-js">
const processForm = (event) => {
	event.preventDefault();
	const detailsSection = document.getElementById('detailsSection');
	const inputForm = document.querySelector(".input-form");
	const parsedData = new FormData(inputForm);
	let formEntries = Object.fromEntries(parsedData.entries());
	formEntries = convertToNumbers(formEntries);
	const formOk = validateEntries(formEntries);
	let summary = calculateSummary(formEntries);
	if (summary) {
		let payments = calculatePayments(summary);
		displayPayments(payments);
		displaySummary(summary);
	}
	setTimeout(() => {detailsSection.scrollIntoView()});
}

const calculatePayments = summary => {
		const {monthlyPayment, interestRate, totalCost, termLength, principal} = summary;
		let remainingPrincipal = principal;
		let totalInterest = 0;
		const tableData = [];
		let lastPayment = false;
	
		for (let i = 0; i < termLength; i++) {
			const breakdown = {
				month: 0,
				payment: 0,
				principal: 0,
				interest: 0,
				totalInterest: 0,
				balance: 0
			}
	
			breakdown.month = i + 1;
			breakdown.interest = (interestRate/1200) * remainingPrincipal;
			totalInterest += breakdown.interest;
			breakdown.totalInterest = totalInterest;
			
			if (lastPayment) {
				breakdown.balance = remainingPrincipal;
				breakdown.principal = breakdown.balance;
				breakdown.payment = breakdown.principal + breakdown.interest;    
				remainingPrincipal -= breakdown.principal;
				breakdown.balance = remainingPrincipal;
				tableData.push(breakdown);
				return tableData
			}
			
			breakdown.payment = monthlyPayment;
			breakdown.principal = breakdown.payment - breakdown.interest;
			remainingPrincipal -= breakdown.principal;
			breakdown.balance = remainingPrincipal;
			
			if (breakdown.balance < breakdown.principal) {
				lastPayment = true;
			}
	
			if (breakdown.balance <= 0) {
				breakdown.balance = 0;
			}
			
			tableData.push(breakdown);
		}
		return tableData;
}

const displayPayments = payments => {
	const table = document.getElementById('paymentsTable');

	const tableHeading = table.querySelector('thead');
	const headerTemplate = document.getElementById('tableHeadingTemplate');
	const headerContent = headerTemplate.content.cloneNode(true);
	tableHeading.innerHTML = '';
	tableHeading.appendChild(headerContent);

	const tableBody = table.querySelector('tbody');
	const rowTemplate = document.getElementById('tableRowTemplate');
	tableBody.innerHTML = '';

	for (let i = 0; i < payments.length; i++) {
		const paymentObj = payments[i];
		const {month, payment, principal, interest, totalInterest, balance} = paymentObj;
		const rowContent  = rowTemplate.content.cloneNode(true);
		const formatOptions = {
			style: "currency",
			currency: "USD"
		};
		
		const tableCells = rowContent.querySelectorAll('td');
		tableCells[0].textContent = month;
		tableCells[1].textContent = payment.toLocaleString('en-US', formatOptions);
		tableCells[2].textContent = principal.toLocaleString('en-US', formatOptions);
		tableCells[3].textContent = interest.toLocaleString('en-US', formatOptions);
		tableCells[4].textContent = totalInterest.toLocaleString('en-US', formatOptions);
		tableCells[5].textContent = balance.toLocaleString('en-US', formatOptions);

		tableBody.appendChild(rowContent);
	}
}

const calculateSummary = entries => {
	const {loanAmount, termLength, interestRate, targetPayment} = entries;
	const summary = {
		monthlyPayment: 0, 
		principal: 0, 
		interest: 0, 
		totalCost: 0, 
		downPayment: 0,
		termLength,
		interestRate
	};

	const minimumPayment = ((loanAmount * (interestRate/1200)) / (1 - (1 + interestRate/1200) ** (-1*termLength)));

	if (!targetPayment) {
		summary.monthlyPayment = Number(minimumPayment);
		summary.principal = loanAmount;
		summary.totalCost = (summary.monthlyPayment * termLength);
		summary.interest = (summary.totalCost - summary.principal);
	} else if (minimumPayment > Number(targetPayment)) {
		summary.monthlyPayment = Number(targetPayment);
		const minimumCost = minimumPayment * termLength;
		summary.totalCost = targetPayment * termLength;
		summary.downPayment = minimumCost - summary.totalCost;
		summary.principal = loanAmount - summary.downPayment;
		summary.interest = summary.totalCost - summary.principal;
	} else {
		const alertMessage = `You won't need to pay any downpayment at any amount above ${minimumPayment.toFixed(2)}$. To still opt for ${targetPayment.toFixed(2)}$, consider reducing the term length.`
		showAlert(alertMessage,"Good News", "success");
		clearTable();
		clearSummary();
		insertLogo();
		return;
	}
	return summary; 
}

const displaySummary = summary => {
	const {monthlyPayment, principal, interest, totalCost, downPayment} = summary;
	clearSummary()
	const detailsTemplate = document.getElementById('detailsTemplate');
	const detailsElement = detailsTemplate.content.cloneNode(true);
	const paymentAmount = detailsElement.querySelector('.payment-headline-amount');
	const principalAmount = detailsElement.getElementById('principalAmount');
	const interestAmount = detailsElement.getElementById('interestAmount');
	const costAmount = detailsElement.getElementById('costAmount');
	const finalAmount = detailsElement.getElementById('finalAmount');
	const formatOptions = {
		style: "currency",
		currency: "USD"
	};
	paymentAmount.innerText = monthlyPayment.toLocaleString('en-US', formatOptions);
	principalAmount.innerText = principal.toLocaleString('en-US', formatOptions);
	interestAmount.innerText = interest.toLocaleString('en-US', formatOptions);
	costAmount.innerText = totalCost.toLocaleString('en-US', formatOptions);
	finalAmount.innerText = downPayment.toLocaleString('en-US', formatOptions);
	detailsSection.appendChild(detailsElement);
	
}

const clearSummary = () => {
	const detailsSection = document.getElementById('detailsSection');
	detailsSection.innerHTML = '';
}

const insertLogo = () => {
	const detailsSection = document.getElementById('detailsSection');
	detailsSection.innerHTML = '&ltimg class="img-fluid opacity-50" src="/img/paycal wallet.svg" style="max-height: 10rem" /&gt';
}

const clearTable = () => {
	const table = document.getElementById('paymentsTable');
	const tableHeading = table.querySelector('thead');
	const tableBody = table.querySelector('tbody');
	tableHeading.innerHTML = '';
	tableBody.innerHTML = '';
}

const convertToNumbers = entries => {
	const refinedEntries = {
		loanAmount: Number(entries.loanAmount),
		termLength: Number(entries.termLength),
		interestRate: Number(entries.interestRate),
	}
	
	if (entries.targetPayment) {
		refinedEntries.targetPayment = Number(entries.targetPayment);
	} else {
		refinedEntries.targetPayment = "";
	}

	return refinedEntries;
}

const validateEntries = entries => {
	const {loanAmount, termLength, interestRate, targetPayment} = entries;
	const loanOk = !isNaN(loanAmount) && loanAmount > 0;
	const termOk = Number.isInteger(termLength) && termLength > 0;
	const interestOk = !isNaN(interestRate) && interestRate > 0;
	const targetOk = Number.isInteger(targetPayment) || targetPayment == "";
	const shortTerm = termLength < 12;
	const rateLow = interestRate < 1;
	const rateHigh = interestRate > 14;
	const lowAmount = loanAmount < 2000;
	
	if (!loanOk) {
		showAlert('Please enter a valid loan amount.', "Oops", "error");
	} else if (!termOk) {
		showAlert('Please enter a valid term.', "Oops", "error");
	} else if (!interestOk) {
		showAlert('Please enter a valid interest rate.', "Oops", "error");
	} else if (!targetOk) {
		showAlert('Please enter a valid target rate.', "Oops", "error");
	} else if (shortTerm) {
		showAlert("Did you enter the loan term in months?", "Just to Confirm", "warning")
		return true;
	} else if (rateLow) {
		showAlert("Please confirm that you have not converted the interest rate to a decimal.", "Just to Confirm", "warning")
		return true;
	} else if (rateHigh) {
		showAlert("We noticed a double digit interest rate. Please confirm if it's correct.", "Just to Confirm", "warning")
		return true;
	} else if (lowAmount) {
		showAlert("Kindly confirm that you've entered the right figure for the loan amount?", "Just to Confirm", "warning");
		return true;
	} else {
		return true;
	}
}

const showAlert = (message, heading, type) => {
	Swal.fire({
		backdrop: false,
		title: heading,
		text: message,
		icon: type,
		confirmButtonColor: '#253439'
	})
}
						</code>
					</pre>
				</div>
				<div class="col-12 col-lg-4">
					<p>The code is structured in one function <code>displayMessage</code>.</p>
					<p><code>displayMessage</code> displayes a sweetAlert when the button is pressed.</p>
				</div>
			</div>
		</main>

		<footer class="py-3 container-fluid">
			<div class="container">
				<div class="row align-items-center row-cols-1 row-cols-lg-3 gy-2">
					<div class="col text-center text-lg-start">&copy; 2023 Taranveer Singh</div>
					<div class="col text-center d-none d-lg-block">
						<a href="https://stirring-medovik-226616.netlify.app/" target="_blank">
							<img src="/Logos/white logo.svg" height="40" />
						</a>
					</div>
					<div class="col text-center text-lg-end">
						<a target="_blank" href="https://www.linkedin.com/in/taranveersingh93/"><i class="bi bi-linkedin"></i></a>
						<a target="_blank" href="https://www.github.com/taranveersingh93/"><i class="bi bi-github"></i></a>
						<a target="_blank" href="mailTo:taranveersingh93@gmail.com"><i class="bi bi-envelope-at"></i></a>
					</div>
				</div>
			</div>
		</footer>

		<script
			src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
			integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
			crossorigin="anonymous"
		></script>
		<script src="/js/prism.js"></script>
		<script>
			Prism.plugins.NormalizeWhitespace.setDefaults({
				"remove-trailing": true,
				"remove-indent": true,
				"left-trim": true,
				"right-trim": true,
			});
		</script>
	</body>
</html>
